{%- set host = pillar['ufconfig']['hosts'][grains.id] %}
{%- set networking = host['networking'] %}
{%- set network = pillar['ufconfig']['networks'][networking['network']] %}
{%- set ifaces = networking.get('ifaces', ['eth0']) %}
{%- set iface1 = ifaces[0] %}
{%- set nameservers = networking['dns-nameservers']|default(network['dns-nameservers']) %}
# This file describes the network interfaces available on your system
# For more information, see netplan(5).
network:
  version: 2
  renderer: networkd
  ethernets:
    {{ iface1 }}:
      dhcp4: no
      dhcp6: no
      addresses: [{{ networking['address'] }}/{{ network['network-prefix'] }}]
      gateway4: {{ network['gateway'] }}
      nameservers:
        search: [{{ network['dns-search'] }}]
        addresses:
{%- for nameserver in nameservers %}
          - {{ nameserver }}
{%- endfor %}

{%- if networking['aliases'] is defined %}
{%- for alias in networking['aliases'] %}
{%- set host = pillar['ufconfig']['hosts'][alias] %}
{%- set networking = host['networking'] %}
{%- set network = pillar['ufconfig']['networks'][networking['network']] %}
{%- set iface = networking.get('iface', ['eth0']) %}
    {{ iface }}:
      dhcp4: no
      dhcp6: no
      addresses: [{{ networking['address'] }}/{{ network['network-prefix'] }}]
{%- if network['routes'] is defined %}
      routes:
{%- for route in network['routes'] %}
        - to: {{ route["to"] }}
          via: {{ route["via"] }}
{% endfor %}
{%- endif %}
{%- endfor %}
{%- endif %}