# Copied from ../workers.yaml for the tomcat-tar state since ".."-paths threw errors
# Transforms pillar ufconif.applications data to a structure suitable for ufrestart-webapp.sh

# servers:
#   <server>:
#     <worker>: <lbworker>

servers:
{%- set applications = pillar['ufconfig']['applications'] %}
{%- for applicationKey, application in applications.items() %}
{%- set workers = application['workers'] %}
{%- if 'servers' in application %}
{%- for serverGroupKey, serverGroup in application['servers'].items() %}
{%- if 'app-servers' in serverGroup %}
{%- for appServerKey, appServer in serverGroup['app-servers'].items() %}
{%- if appServer['host'] == grains.id %}
{%- for webServer in serverGroup['web-servers'] %}
  {{ webServer }}:
    {{ appServerKey }}: {{ workers['load-balancer']['name'] }}
{%- endfor %}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endfor %}
{%- endif %}
{%- endfor %}
